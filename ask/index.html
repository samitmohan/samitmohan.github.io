<!-- ask/index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Ask Samit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Markdown renderer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
                   Roboto, Arial, sans-serif;
      background: #ffffff;
      margin: 0;
      padding: 2rem;
      color: #111;
    }

    .container {
      max-width: 820px;
      margin: auto;
    }

    h1 {
      font-size: 2.2rem;
      margin-bottom: 0.2rem;
    }

    .subtitle {
      color: #555;
      margin-bottom: 1.5rem;
    }

    textarea {
      width: 100%;
      min-height: 110px;
      font-size: 15px;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      resize: vertical;
    }

    button {
      margin-top: 10px;
      padding: 10px 18px;
      font-size: 15px;
      border-radius: 6px;
      border: 1px solid #333;
      background: #111;
      color: #fff;
      cursor: pointer;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    h3, h4 {
      margin-top: 2rem;
      margin-bottom: 0.6rem;
    }

    #answer {
      line-height: 1.6;
    }

    pre {
      background: #f6f8fa;
      padding: 12px;
      border-radius: 6px;
      overflow-x: auto;
    }

    code {
      background: #f6f8fa;
      padding: 2px 4px;
      border-radius: 4px;
    }

    .sources {
      font-size: 14px;
      color: #444;
    }

    .source-item {
      margin-bottom: 4px;
    }

    .hint {
      font-size: 13px;
      color: #777;
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Ask Samit</h1>
    <p class="subtitle">
      Ask questions about posts on <strong>samitmohan.github.io</strong>
    </p>

    <textarea
      id="query"
      placeholder="Why is softmax used in MNIST?"
    ></textarea>

    <div class="hint">
      Press <strong>Ctrl + Enter</strong> (or <strong>Cmd + Enter</strong>) to ask
    </div>

    <button id="ask">Ask</button>

    <h3>Answer</h3>
    <div id="answer">No answer yet.</div>

    <h4>Sources</h4>
    <div id="sources" class="sources"></div>
  </div>

  <script>
    const BACKEND =
      location.hostname === "localhost"
        ? "http://localhost:8000"
        : "https://starsmerchant-language-drug-statistical.trycloudflare.com";

    const askBtn = document.getElementById("ask");
    const queryBox = document.getElementById("query");
    const answerDiv = document.getElementById("answer");
    const sourcesDiv = document.getElementById("sources");

    async function askQuestion() {
      const query = queryBox.value.trim();
      if (!query) {
        alert("Please type a question.");
        return;
      }

      askBtn.disabled = true;
      askBtn.textContent = "Thinking…";
      answerDiv.textContent = "Thinking…";
      sourcesDiv.innerHTML = "";

      try {
        const resp = await fetch(`${BACKEND}/query`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query, top_k: 3 })
        });

        const data = await resp.json();

        if (!data.answer) {
          answerDiv.textContent =
            "I don’t know based on the information in my posts.";
          return;
        }

        // Render markdown answer
        answerDiv.innerHTML = marked.parse(data.answer);

        // Render sources
        const citations = data.citations || [];
        citations.forEach(c => {
          const div = document.createElement("div");
          div.className = "source-item";

          const title = c.url
            ? `<a href="${c.url}" target="_blank">${c.chunk_id}</a>`
            : c.chunk_id;

          div.innerHTML =
            `${title} — ${c.type}` +
            (c.section ? ` (section: ${c.section})` : "");

          sourcesDiv.appendChild(div);
        });

      } catch (err) {
        answerDiv.textContent = "Error: " + err.toString();
      } finally {
        askBtn.disabled = false;
        askBtn.textContent = "Ask";
      }
    }

    askBtn.onclick = askQuestion;

    queryBox.addEventListener("keydown", e => {
      if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) {
        askQuestion();
      }
    });
  </script>
</body>
</html>
